<div class="container mt-4">
  <div class="row">
    <!-- Left Column: Account Search & Details -->
    <div class="col-md-6">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-wallet2 me-2"></i> Rechercher un Compte
        </div>
        <div class="card-body">

          <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <form
              [formGroup]="accountFormGroup"
              (ngSubmit)="handleSearchAccount()"
              class="d-flex flex-grow-1 gap-2"
            >
              <input
                type="text"
                formControlName="accountId"
                class="form-control form-control-sm"
                placeholder="Search account ID..."
              />
              <button type="submit" class="btn btn-info btn-sm text-white">
                <i class="bi bi-search"></i>
              </button>
            </form>

            <div *ngIf="accountFormGroup.get('accountId')?.value" class="text-end">
              <div class="badge bg-light text-dark border px-3 py-2">
                <span class="text-uppercase text-muted small">Active Account</span><br />
                <code class="fw-bold">{{ accountFormGroup.get('accountId')?.value }}</code>
              </div>
            </div>
          </div>

          <!-- D√©tails du compte ou message d'erreur/chargement -->
          <ng-container *ngIf="accountObservable | async as accountDetails; else loadingOrError">
            <!-- Informations du compte -->
            <div class="mb-3">
              <span class="fw-semibold">Balance:</span>
              <span
                [ngClass]="{
                'text-success fw-bold':accountDetails.balance>=0,
                'text-danger fw-bold':accountDetails.balance<0
              }"
              >{{ accountDetails.balance | number:'1.2-2' }} MAD</span
              >
            </div>

            <div class="mb-3 d-flex align-items-center gap-2">
              <span class="fw-semibold mb-0">Status:</span>
              <span
                class="badge px-3 py-2 rounded-pill text-white shadow-sm"
                [ngClass]="{
                      'bg-success': accountDetails.status === 'ACTIVE',
                      'bg-warning text-dark': accountDetails.status === 'PENDING',
                      'bg-danger': accountDetails.status === 'BLOCKED' || accountDetails.status === 'CLOSED',
                      'bg-secondary': accountDetails.status === 'INACTIVE'
                    }"
              >
                <i class="bi bi-shield-lock me-1"></i>
                {{ accountDetails.status }}
              </span>
            </div>

            <div class="mb-2">
              <strong>Type: </strong>
              <span
                class="badge"
                [ngClass]="{
                'bg-info': accountDetails.type === 'Current',
                'bg-warning text-dark': accountDetails.type === 'Saving'
              }"
              >
                {{ accountDetails.type}}
              </span>
            </div>

            <div *ngIf="accountDetails.type === 'Saving'" class="mb-3">
              <label class="form-label">Interest Rate (%)</label>
              <div class="input-group">
                <input
                  type="number"
                  [(ngModel)]="newInterestRate"
                  class="form-control"
                  min="0"
                  step="0.1"
                />
                <button
                  class="btn btn-outline-success"
                  (click)="updateInterestRate()"
                >
                  <i class="bi bi-arrow-repeat"></i> Update
                </button>
              </div>
            </div>

            <div *ngIf="accountDetails.type === 'Current'" class="mb-3">
              <label class="form-label">Overdraft Limit (MAD)</label>
              <div class="input-group">
                <input
                  type="number"
                  [(ngModel)]="newOverdraftLimit"
                  class="form-control"
                  min="0"
                  step="100"
                />
                <button
                  class="btn btn-outline-success"
                  (click)="updateOverdraftLimit()">
                  <i class="bi bi-arrow-repeat"></i> Update
                </button>
              </div>
            </div>

            <form
              [formGroup]="filterFormGroup"
              (ngSubmit)="searchOperations()"
              class="mb-3"
            >
              <div class="row g-2">
                <div class="col-md-3">
                  <label for="startDate" class="form-label small">Date d√©but</label>
                  <input
                    type="date"
                    id="startDate"
                    formControlName="startDate"
                    class="form-control form-control-sm"
                  />
                </div>

                <div class="col-md-3">
                  <label for="endDate" class="form-label small">Date fin</label>
                  <input
                    type="date"
                    id="endDate"
                    formControlName="endDate"
                    class="form-control form-control-sm"
                  />
                </div>

                <div class="col-md-2">
                  <label for="minAmount" class="form-label small">Min (MAD)</label>
                  <input
                    type="number"
                    id="minAmount"
                    formControlName="minAmount"
                    class="form-control form-control-sm"
                    placeholder="0"
                    step="0.01"
                  />
                </div>

                <div class="col-md-2">
                  <label for="maxAmount" class="form-label small">Max (MAD)</label>
                  <input
                    type="number"
                    id="maxAmount"
                    formControlName="maxAmount"
                    class="form-control form-control-sm"
                    placeholder="100000"
                    step="0.01"
                  />
                </div>

                <div class="col-md-2 d-flex align-items-end gap-1">
                  <button
                    type="submit"
                    class="btn btn-primary btn-sm flex-fill"
                    title="Rechercher"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                  <button
                    type="button"
                    class="btn btn-secondary btn-sm"
                    (click)="clearFilters()"
                    title="R√©initialiser"
                  >
                    <i class="bi bi-x-circle"></i>
                  </button>
                </div>
              </div>

              <!-- Indicateur de filtres actifs -->
              <div *ngIf="hasActiveFilters()" class="mt-2">
                <span class="badge bg-info">
                  <i class="bi bi-funnel-fill me-1"></i>
                      Filtres actifs
                </span>
              </div>
            </form>


            <!-- Table des op√©rations -->
            <div class="table-responsive">
              <table class="table table-hover table-sm align-middle">
                <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Date</th>
                  <th class="text-end">Amount</th>
                  <th class="text-center">Type</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let op of accountDetails.accountOperationDTOS">
                  <td>{{ op.id }}</td>
                  <td>
                    {{ op.operationDate | date: 'dd-MM-yyyy HH:mm:ss' }}
                  </td>
                  <td class="text-end">{{ op.amount | number: '1.2-2' }}</td>
                  <td class="text-center">
                      <span
                        class="badge"
                        [ngClass]="op.type === 'CREDIT' ? 'bg-success' : 'bg-danger'"
                      >
                        {{ op.type }}
                      </span>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <nav class="d-flex flex-wrap">
              <a *ngFor="let _ of [].constructor(accountDetails.totalPages); let page=index"
                 class="btn me-2 mb-2"
                 [ngClass]="page === currentPage ? 'btn-info' : 'btn-outline-info'"
                 (click)="gotoPage(page)">
                {{ page }}
              </a>
            </nav>
          </ng-container>

          <!-- Template pour chargement ou erreur -->
          <ng-template #loadingOrError>
            <div *ngIf="errorMessage" class="alert alert-danger">
              {{ errorMessage }}
            </div>
            <div *ngIf="!errorMessage" class="text-muted">Chargement...</div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Right Column: Operation Form -->
    <div class="col-md-6">
      <div *ngIf="accountObservable" class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <i class="bi bi-gear me-2"></i> Op√©rations sur le Compte
        </div>
        <div class="card-body" *ngIf="authService.roles.includes('ADMIN')">
          <div *ngIf="authService.roles.includes('ADMIN')" class="mb-4">
            <label class="form-label fw-semibold">Change Account Status</label>
            <div class="input-group">
              <select
                class="form-select"
                [(ngModel)]="selectedStatus"
                [ngModelOptions]="{ standalone: true }"
              >
                <option *ngFor="let status of statuses" [value]="status">
                  {{ status }}
                </option>
              </select>
              <button
                class="btn btn-outline-success fw-semibold"
                type="button"
                (click)="updateStatus()"
              >
                <i class="bi bi-shield-check me-1"></i>Update
              </button>
            </div>
          </div>
          <form [formGroup]="opertaionFromGroup" (ngSubmit)="handleAccountOperation()">
            <!-- Type d'op√©ration -->
            <div class="mb-3">
              <label class="form-label">Type d'op√©ration</label>
              <div class="form-check form-check-inline" *ngFor="let type of ['DEBIT', 'CREDIT', 'TRANSFER']">
                <input class="form-check-input" type="radio" formControlName="operationType" [value]="type">
                <label class="form-check-label">{{ type }}</label>
              </div>
            </div>

            <!-- Compte destinataire (uniquement pour TRANSFER) -->
            <div *ngIf="opertaionFromGroup.get('operationType')?.value === 'TRANSFER'" class="mb-3">
              <label class="form-label fw-semibold">Compte destinataire</label>

              <select class="form-select shadow-sm rounded-3" formControlName="accountDestination">
                <option value="" disabled selected>-- Choisir un b√©n√©ficiaire --</option>

                <option *ngFor="let acc of beneficiaries" [value]="acc.compteDestinataire">
                  üí≥ {{ acc.nom | titlecase }} ‚Äî {{ acc.compteDestinataire }}
                </option>
              </select>
            </div>






            <!-- Montant -->
            <div class="mb-3">
              <label class="form-label">Montant</label>
              <input type="number" class="form-control" formControlName="amount">
            </div>

            <!-- Description -->
            <div class="mb-3">
              <label class="form-label">Description</label>
              <input type="text" class="form-control" formControlName="description">
            </div>

            <!-- Bouton de validation -->
            <button class="btn btn-success w-100" type="submit">
              <i class="bi bi-check-circle me-2"></i> Valider l'op√©ration
            </button>
          </form>
          <div *ngIf="opertaionFromGroup.get('operationType')?.value === 'TRANSFER'" class="mb-3">
            <button class="btn w-100 mt-3"
                    style="border: 2px solid #198754; color: #198754; background-color: white;"
                    (click)="openAddBeneficiary()">
              <i class="bi bi-person-plus me-2"></i> AJOUTER UN B√âN√âFICIAIRE
            </button>


            <!-- Bouton : G√âRER MES B√âN√âFICIAIRES -->
            <button class="btn w-100 mt-3"
                    style="border: 2px solid #198754; color: #198754; background-color: white;"
                    (click)="openManageBeneficiary()">
              <i class="bi bi-gear me-2"></i> G√âRER MES B√âN√âFICIAIRES
            </button>

          </div>
        </div>
      </div>
      <div class="modal fade show"
           tabindex="-1"
           *ngIf="showAddBeneficiaryModal"
           style="display:block; background: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
          <div class="modal-content shadow-lg">

            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">Ajouter un b√©n√©ficiaire</h5>
              <button type="button" class="btn-close" (click)="closeAddBeneficiary()"></button>
            </div>

            <form [formGroup]="beneficiaryForm" (ngSubmit)="saveBeneficiary()">
              <div class="modal-body">

                <div class="mb-3">
                  <label class="form-label">Nom complet *</label>
                  <input type="text" class="form-control" formControlName="nom">
                </div>

                <div class="mb-3">
                  <label class="form-label">Compte b√©n√©ficiaire *</label>
                  <input type="text" class="form-control" formControlName="compteDestinataire">
                </div>

              </div>

              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" (click)="closeAddBeneficiary()">Annuler</button>
                <button class="btn btn-success" type="submit">
                  <i class="bi bi-check-circle me-2"></i> Ajouter
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Modal : G√©rer mes b√©n√©ficiaires -->
      <div class="modal fade show"
           tabindex="-1"
           *ngIf="showManageBeneficiaryModal"
           style="display:block; background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-lg">
          <div class="modal-content shadow-lg">

            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">G√©rer mes b√©n√©ficiaires</h5>
              <button type="button" class="btn-close" (click)="closeManageBeneficiary()"></button>
            </div>

            <div class="modal-body">
              <table class="table table-hover table-bordered">
                <thead class="table-light">
                <tr>
                  <th>Nom</th>
                  <th>Compte destinataire</th>
                  <th class="text-center">Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let b of beneficiaries; let i = index">
                  <td>
                    <span class="form-control form-control-sm bg-light">{{ b.id }}</span>
                  </td>
                  <td>
                    <input type="text" class="form-control form-control-sm"
                           [(ngModel)]="b.nom" />
                  </td>
                  <td>
                    <input type="text" class="form-control form-control-sm"
                           [(ngModel)]="b.compteDestinataire" />
                  </td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-primary me-2" (click)="updateBeneficiary(i)">
                      <i class="bi bi-pencil"></i> Sauvegarder
                    </button>
                    <button class="btn btn-sm btn-danger" (click)="removeBeneficiary(i)">
                      <i class="bi bi-trash"></i> Supprimer
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>

              <div *ngIf="beneficiaries.length === 0" class="text-muted text-center">
                Aucun b√©n√©ficiaire trouv√©.
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn btn-secondary" (click)="closeManageBeneficiary()">Fermer</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
